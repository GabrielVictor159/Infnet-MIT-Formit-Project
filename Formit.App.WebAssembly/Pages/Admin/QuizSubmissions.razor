@page "/quiz/{QuizId:int}/submissions"
@using Formit.Shared.DTOs
@using Formit.App.Services.Interfaces
@using Formit.App.WebAssembly.Components
@inject ISubmissionService SubmissionService
@inject IAuthenticationService AuthService
@inject IQuizService QuizService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">

    <div class="d-flex align-center mb-6">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/quizzes" Class="mr-4" />
        <div>
            <MudText Typo="Typo.h4">Results</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                @(_quizTitle ?? "Loading...")
            </MudText>
        </div>
    </div>

    <MudTable Items="_submissions" Hover="true" Loading="_isLoading" Elevation="3" Filter="new Func<SubmissionSummaryDto,bool>(FilterFunc)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Submissions Received</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Search by name..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
        </ToolBarContent>

        <HeaderContent>
            <MudTh>User</MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Score</MudTh>
            <MudTh Style="text-align:center">Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="User">
                <div class="d-flex align-center">
                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3">@context.UserName?.FirstOrDefault()</MudAvatar>
                    <MudText>@context.UserName</MudText>
                </div>
            </MudTd>
            <MudTd DataLabel="Date">@context.SubmissionDate.ToLocalTime().ToString("g")</MudTd>
            <MudTd DataLabel="Score">
                <MudChip T="string" Color="@GetScoreColor(context.Score)" Size="Size.Small" Variant="Variant.Filled">
                    @context.Score pts
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Actions" Style="text-align:center">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           Size="Size.Small"
                           OnClick="@(() => ViewDetails(context.Id))">
                    View Details
                </MudButton>
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager />
        </PagerContent>

        <NoRecordsContent>
            <MudText>No answers were found for this quiz.</MudText>
        </NoRecordsContent>
    </MudTable>

</MudContainer>

@code {
    [Parameter] public int QuizId { get; set; }

    private bool _isAdmin = false;
    private bool _isLoading = true;
    private string? _quizTitle;
    private List<SubmissionSummaryDto> _submissions = new();
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        bool isAdmin = await AuthService.IsUserAdminAsync();
        if (!isAdmin)
        {
            Navigation.NavigateTo("/");
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        var quiz = await QuizService.GetByIdAsync(QuizId);
        _quizTitle = quiz?.Title;

        var result = await SubmissionService.GetSubmissionsByQuizIdAsync(QuizId);
        _submissions = result.ToList();
        _isLoading = false;
    }

    private Color GetScoreColor(int score)
    {
        if (score >= 80) return Color.Success;
        if (score >= 50) return Color.Warning;
        return Color.Error;
    }

    private bool FilterFunc(SubmissionSummaryDto element)
    {
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        if (element.UserName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        return false;
    }

    private async Task ViewDetails(int submissionId)
    {
        var parameters = new DialogParameters<SubmissionDetailsDialog>
        {
            { x => x.SubmissionId, submissionId }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };

        await DialogService.ShowAsync<SubmissionDetailsDialog>("Response Details", parameters, options);
    }
}