@page "/users/{Id}"
@using Formit.Shared.DTOs
@using Formit.App.Services.Interfaces
@using Formit.App.WebAssembly.Components
@using System.ComponentModel.DataAnnotations
@using Formit.Shared.DTOs.Requests
@using Microsoft.AspNetCore.Authorization

@inject IAuthenticationService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService


<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">

    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Href="/users" Class="mb-4">Back to List</MudButton>

    <MudText Typo="Typo.h4" GutterBottom="true">Edit User</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else if (_model != null)
    {
        <EditForm Model="@_model" OnValidSubmit="UpdateUser" Context="editContext">
            <DataAnnotationsValidator />
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField Label="Full Name" @bind-Value="_model.FullName" For="@(() => _model.FullName)"
                                Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField Label="E-mail" @bind-Value="_model.Email" For="@(() => _model.Email)"
                                Variant="Variant.Outlined" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudSelect T="string" Label="Roles" MultiSelection="true" @bind-SelectedValues="_selectedRoles"
                                Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                @foreach (var role in _availableRoles)
                                {
                                    <MudSelectItem T="string" Value="@role">@role</MudSelectItem>
                                }
                            </MudSelect>
                            @if (!_selectedRoles.Any())
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">At least one role is required.</MudText>
                            }
                        </MudItem>
                    </MudGrid>
                </MudCardContent>

                <MudCardActions Class="d-flex justify-space-between pa-4">
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                        OnClick="ConfirmDelete">
                        Delete User
                    </MudButton>

                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                        Disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Saving...</MudText>
                        }
                        else
                        {
                            <MudText>Save Changes</MudText>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </EditForm>
    }
    else
    {
        <MudAlert Severity="Severity.Error">User not found.</MudAlert>
    }
</MudContainer>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private bool _isLoading = true;
    private bool _isSaving = false;

    private AdminUpdateUserDto _model = new();

    private List<string> _availableRoles = new();
    private IEnumerable<string> _selectedRoles = new HashSet<string>();

    protected override async Task OnInitializedAsync()
    {
        bool isAdmin = await AuthService.IsUserAdminAsync();
        if (!isAdmin)
        {
            Navigation.NavigateTo("/");
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        var user = await AuthService.GetUserByIdAsync(Id);

        var roles = await AuthService.GetAllRoles();
        _availableRoles = roles.ToList();

        if (user != null)
        {
            _model = new AdminUpdateUserDto
            {
                FullName = user.FullName,
                Email = user.Email,
                Roles = user.Roles.ToList()
            };

            _selectedRoles = user.Roles;
        }
        else
        {
            _model = null!;
        }

        _isLoading = false;
    }

    private async Task UpdateUser()
    {
        _model.Roles = _selectedRoles.ToList();

        if (!_model.Roles.Any())
        {
            Snackbar.Add("You must select at least one role.", Severity.Warning);
            return;
        }

        _isSaving = true;
        var result = await AuthService.UpdateUserAsync(Id, _model);
        _isSaving = false;

        if (result.Success)
        {
            Snackbar.Add("User updated successfully!", Severity.Success);
            Navigation.NavigateTo("/users");
        }
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmationDialog>
{
{ x => x.ContentText, $"Are you sure you want to delete {_model.FullName}? This action cannot be undone." },
{ x => x.ButtonText, "Delete" },
{ x => x.Color, Color.Error }
};

        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete User", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await DeleteUser();
        }
    }

    private async Task DeleteUser()
    {
        var result = await AuthService.DeleteUserAsync(Id);

        if (result.Success)
        {
            Snackbar.Add("User deleted successfully.", Severity.Success);
            Navigation.NavigateTo("/users");
        }
    }


}