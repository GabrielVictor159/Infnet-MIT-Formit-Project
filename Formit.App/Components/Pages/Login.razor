@page "/login"
@using Formit.Shared.DTOs
@using Formit.App.Services.Interfaces
@layout AuthLayout
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="height: 80vh;">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12">
            <EditForm Model="@_loginModel" OnValidSubmit="ExecuteLogin">
                <DataAnnotationsValidator />

                <MudCard Elevation="4" Class="pa-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary" Class="mb-2"><b>Welcome Back</b></MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Sign in to continue to Formit</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent>
                        <MudTextField Label="Email"
                                      @bind-Value="_loginModel.Email"
                                      For="@(() => _loginModel.Email)"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Email"
                                      Class="mb-4" />

                        <MudTextField Label="Password"
                                      @bind-Value="_loginModel.Password"
                                      For="@(() => _loginModel.Password)"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      InputType="@_passwordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_passwordInputIcon"
                                      OnAdornmentClick="TogglePasswordVisibility"
                                      Class="mb-2" />

                    </MudCardContent>

                    <MudCardActions Class="d-flex flex-column gap-2 px-4 pb-4">
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Signing in...</MudText>
                            }
                            else
                            {
                                <MudText>Sign In</MudText>
                            }
                        </MudButton>

                        <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2">
                            Don't have an account? <MudLink Href="/register" Color="Color.Secondary" Underline="Underline.Always">Register</MudLink>
                        </MudText>
                    </MudCardActions>
                </MudCard>
            </EditForm>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private LoginDto _loginModel = new();
    private bool _isLoading = false;

    bool _isShowPassword = false;
    InputType _passwordInputType = InputType.Password;
    string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        if (_isShowPassword)
        {
            _isShowPassword = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInputType = InputType.Password;
        }
        else
        {
            _isShowPassword = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInputType = InputType.Text;
        }
    }

    private async Task ExecuteLogin()
    {
        _isLoading = true;

        var result = await AuthService.LoginAsync(_loginModel);

        _isLoading = false;

        if (result.Success)
        {
            Snackbar.Add($"Welcome back, {result.UserName}!", Severity.Success);
        }
    }
}