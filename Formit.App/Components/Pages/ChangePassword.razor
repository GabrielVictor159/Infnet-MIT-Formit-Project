@page "/change-password"
@using Formit.Shared.DTOs
@using Formit.App.Services.Interfaces
@using System.ComponentModel.DataAnnotations
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@inject IAuthenticationService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <EditForm Model="@_model" OnValidSubmit="SubmitChangePassword">
        <DataAnnotationsValidator />
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">Change Password</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField Label="Current Password"
                                      @bind-Value="_model.CurrentPassword"
                                      For="@(() => _model.CurrentPassword)"
                                      Variant="Variant.Outlined"
                                      InputType="@_passwordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="New Password"
                                      @bind-Value="_model.NewPassword"
                                      For="@(() => _model.NewPassword)"
                                      Variant="Variant.Outlined"
                                      InputType="@_passwordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Confirm New Password"
                                      @bind-Value="_model.ConfirmNewPassword"
                                      For="@(() => _model.ConfirmNewPassword)"
                                      Variant="Variant.Outlined"
                                      InputType="@_passwordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions Class="d-flex justify-space-between pa-4">
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="GoBack">
                    Cancel
                </MudButton>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Processing...</MudText>
                    }
                    else
                    {
                        <MudText>Change Password</MudText>
                    }
                </MudButton>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudContainer>

@code {
    private bool _isSaving = false;
    private ChangePasswordDto _model = new();

    private bool _isShowPassword;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        if (_isShowPassword)
        {
            _isShowPassword = false;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInputType = InputType.Password;
        }
        else
        {
            _isShowPassword = true;
            _passwordIcon = Icons.Material.Filled.Visibility;
            _passwordInputType = InputType.Text;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/profile");
    }

    private async Task SubmitChangePassword()
    {
        _isSaving = true;

        var result = await AuthService.ChangePasswordAsync(_model);

        _isSaving = false;

        if (result.Success)
        {
            Snackbar.Add("Password changed successfully!", Severity.Success);
            Navigation.NavigateTo("/profile");
        }
    }
}